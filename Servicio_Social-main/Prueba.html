<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laberinto Interactivo</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: url('IMAGENES/NieveAncho.jpg');
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            margin: 0;
            font-family: Arial, sans-serif;
            transition: background-image 0.5s ease-in-out;
        }

        .header {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .titulo {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
        }
        .boton-regresar {
            background-color: var(--color-tema);
            color: white;
            font-size: 1.2em;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .boton-regresar:hover {
            background-color: #027a9e;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 80px;
        }

        .controls-container {
            border: 2px solid var(--color-tema);
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        #controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }
        #controls button {
            border: 2px solid #333;
            font-size: 24px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-tema);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #controls button:hover {
            transform: scale(1.1);
            filter: brightness(1.1);
        }

        #command-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            align-items: center;
        }

        #maze-container {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        @media (max-width: 768px), (resolution: 125dpi) {
            #maze-container {
                flex-direction: column;
                align-items: center;
            }            
            #instructions, #command-list-container {
                width: 100%;
                max-width: 300px;
            }
            
            body[data-mundo="1"] #maze {
                max-width: 125%;
            }

            body[data-mundo="2"] #maze{
                max-width: 110%;
            }
            
            body[data-mundo="3"] #maze {
                max-width: 100%;
            }
            
            .game-container {
                margin-top: 60px;
            }
            
            .controls-container {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            #controls button {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }

        @media screen and (resolution: 125dpi) {
            body[data-mundo="1"] #maze {
                max-width: 125%;
            }
            
            body[data-mundo="2"] #maze {
                max-width: 110%;
            }
            
            body[data-mundo="3"] #maze {
                max-width: 100%;
            }
            
            /* Ajustar tamaño de celdas si es necesario */
            body[data-mundo="1"] .cell,
            body[data-mundo="2"] .cell,
            body[data-mundo="3"] .cell {
                width: 25px;
                height: 25px;
            }
        }

        #maze {
            display: grid;
            gap: 1px;
            padding: 10px;
            max-width: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.1);
        }

        #instructions, #command-list-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            font-size: 1.2em;
            width: 198px;
            text-align: center;
            animation: tut 8s infinite;
        }
        #instructions h3, #command-list-container h3 {
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .cell {
            position: relative;
            aspect-ratio: 1/1;
            width: 100%;
            height: auto;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center center;
            transition: all 0.3s ease;
            border: none !important;
        }

        .wall { 
            background-image: url('IMAGENES/Desierto/pared_desierto.png');
            background-size: contain;
        }
        .door { 
            background-image: url('IMAGENES/Desierto/puerta_desierto.png');
            background-size: contain;
        }
        .chest { 
            background-image: url('IMAGENES/Desierto/cofre_desierto.png');
            background-size: contain;
        }
        .goal { 
            background-image: url('IMAGENES/Desierto/meta_desierto.png');
            background-size: contain;
        }
        .player { 
            background-image: url('IMAGENES/Desierto/drago_desierto.png');
            background-size: contain;
        }

        #commands {
            margin-top: 10px;
            text-align: center;
        }

        #modal, #win-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        #modal-content, #win-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
        }

        .star { font-size: 30px; }
        .gold { color: gold; }
        .black { color: black; }
       
        .star.gold {
            animation: shine 1s infinite;
        }
        .blink {
            animation: blink 1s infinite;
            font-weight: bold;
        }

        @keyframes shine {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        @keyframes blink {
            0% { color: black; }
            50% { color: gold; }
            100% { color: black; }
        }
        
        /*estilos diferentes de botones*/
        @keyframes tut-desierto {
            0% { background-color: #f5e8d0; }
            50% {  background-color: #e6b17e;}
            100% { background-color: #f5e8d0; }
        }
        @keyframes tut-jungla {
            0% { background-color: #d8f3dc; }
            50% { background-color: #6aab6d;}
            100% { background-color: #d8f3dc; }
        }
        @keyframes tut-hielo {
            0% { background-color: #e2f3fd; }
            50% { background-color: #8bc8f5;  }
            100% { background-color: #e2f3fd; }
        }

        /*  animaciones según el mundo */
        body[data-mundo="1"] .iniciar {
            background-color: #c2b280;
        } body[data-mundo="1"] .iniciar:hover { background-color: #be9f42;}
        
        body[data-mundo="2"] .iniciar {
            background-color:  #4a7729;
        } body[data-mundo="2"] .iniciar:hover { background-color: #75b349;}
        
        body[data-mundo="3"] .iniciar {
            background-color:  #67c0ff;
        } body[data-mundo="3"] .iniciar:hover { background-color: #2577b3;}

        body[data-mundo="1"] #tuto,
        body[data-mundo="1"] #tuto2,
        body[data-mundo="1"] #instructions,
        body[data-mundo="1"] #command-list-container {
            animation: tut-desierto 8s infinite;
        }

        body[data-mundo="2"] #tuto,
        body[data-mundo="2"] #tuto2,
        body[data-mundo="2"] #instructions,
        body[data-mundo="2"] #command-list-container {
            animation: tut-jungla 8s infinite;
        }

        body[data-mundo="3"] #tuto,
        body[data-mundo="3"] #tuto2,
        body[data-mundo="3"] #instructions,
        body[data-mundo="3"] #command-list-container {
            animation: tut-hielo 8s infinite;
        }

        .iniciar {
            font-size: 24px;
            width: auto;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-tema);
            color: whitesmoke;
            border: none;
            border-radius: 5px;
            border: solid black 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .continuar {
            font-size: 24px;
            width: auto;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: whitesmoke;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid black;
            background-color: var(--color-tema);
        }

        .mensaje-emergente {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 2em;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 30;
        }
        
        #tuto, #tuto2 {
            animation: tut 8s infinite;
        }

        .level-indicator {
            position: fixed;
            top: 80px;
            left: 20px;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-weight: bold;
            z-index: 5;
        }
    </style>
</head>
<body>

    <!-- Menú superior -->
    <div class="header">
        <button class="boton-regresar" onclick="window.location.href='inicio.html'">Regresar</button>
        <div class="titulo">LABERINTO INTERACTIVO</div>

        <div style="margin-right: 70px;"> </div>
    </div>

    <!-- Indicador de nivel -->
    <div class="level-indicator">Nivel: <span id="current-level">1</span></div>

    <!-- Contenedor del juego -->
    <div class="game-container">
        <!-- Contenedor para los botones de control -->
        <div class="controls-container">
            <div id="controls">
                <button onclick="addCommand('up')">↑</button>
                <button onclick="addCommand('down')">↓</button>
                <button onclick="addCommand('left')">←</button>
                <button onclick="addCommand('right')">→</button>
            </div>
        </div>

        <!-- Laberinto -->
        <div id="maze-container">
            <div id="instructions">
                <h3>🎯 Objetivos</h3>
                <ul>
                    <li>Pasar la puerta</li>
                    <li>Conseguir el cofre</li>
                    <li>Llegar a la meta</li>
                </ul>
            </div>
        
            <div id="maze" style="display: grid; gap: 2px; background-image: url('IMAGENES/Desierto/mapa_desierto.jpg'); background-size: cover; padding: 10px; border: 2px solid #333; max-width: 100%; overflow: auto;"></div>
        
            <div id="command-list-container">
                <h3>🕹 Movimientos</h3>
                <div id="command-list"></div>
            </div>
        </div>

        <!-- Botón de inicio -->
        <div id="commands">
            <button class="iniciar" onclick="startGame()">Iniciar</button>
        </div>
    </div>

    <!-- Modales -->
    <div id="modal">
        <div id="modal-content">
            <p style="font-size: x-large;" id="question"></p>
            <input type="number" id="answer" min="0" step="1">
            <button onclick="checkAnswer()">Responder</button>
        </div>
    </div>

    <div id="win-modal" style="display:none;">
        <div id="win-modal-content">
            <h2>¡Nivel Completado!</h2>
            <div>
                <span id="star1" class="star">★</span>
                <span id="star2" class="star">★</span>
                <span id="star3" class="star">★</span>
            </div>
            <p>Metas:</p>
            <ul>
                <li id="goal-door">Pasar la puerta</li>
                <li id="goal-chest">Conseguir el cofre</li>
                <li id="goal-finish">Llegar a la meta</li>
            </ul>
            <div style="margin-top: 20px;">
                <button onclick="changeLevel(1)" style="margin: 5px; padding: 10px 20px;">🔁 Reiniciar Nivel</button>
                <button onclick="changeLevel(2)" style="margin: 5px; padding: 10px 20px;">➡️ Siguiente Nivel</button>
            </div>
        </div>
    </div>    

    <div id="restart-message" class="mensaje-emergente">
        Te quedaste sin movimientos. ¡Intentémoslo de nuevo!
    </div>

    <div id="tuto" class="mensaje-emergente">
        Este es tu personaje: <div id="tuto-personaje" style="width: 40px; height: 40px; display: inline-block; background-size: contain; background-repeat: no-repeat;"></div>
        <div>
            Piso <div class="tuto-img" data-type="piso" style="width: 40px; height: 40px; display: inline-block; background-size: contain; background-repeat: no-repeat;"></div>
            Pared <div class="tuto-img" data-type="pared" style="width: 40px; height: 40px; display: inline-block; background-size: contain; background-repeat: no-repeat;"></div>
        </div>
        <div><br>
            Cofre <div class="tuto-img" data-type="cofre" style="width: 40px; height: 40px; display: inline-block; background-size: contain; background-repeat: no-repeat;"></div>
            Puerta <div class="tuto-img" data-type="puerta" style="width: 40px; height: 40px; display: inline-block; background-size: contain; background-repeat: no-repeat;"></div>
        </div><br>
            Meta <div class="tuto-img" data-type="meta" style="width: 40px; height: 40px; display: inline-block; background-size: contain; background-repeat: no-repeat;"></div>
            
        <div style="margin-top: 70px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <button class="iniciar" onclick="tutorial(1)">Siguiente</button>
        </div>
    </div>

    <div id="tuto2" class="mensaje-emergente" style="font-size: 30px;">  
        <p>Presiona los botones!</p>
        <div id="controls">
            <button>↑</button>arriba
            <button>↓</button>abajo
            <button>←</button>izquierda
            <button>→</button>derecha
        </div>       
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <p>Dale al boton</p>
            <button class="iniciar">Iniciar</button>
            <p>Para mover a tu personaje</p>
        </div>
        <div>
            <h5>Presiona el siguiente boton para comenzar a jugar</h5>
            <button class="continuar" onclick="tutorial(2)">CONTINUAR</button>
        </div>
    </div>

    <script>
        // ========== CONSTANTES Y CONFIGURACIÓN ==========
        const CELL_TYPES = {
            EMPTY: ' ',
            WALL: 'wall',
            DOOR: 'door',
            CHEST: 'chest', 
            GOAL: 'goal'
        };

        const estilosMundos = {
            1: { // Mundo Desierto
                fondo: "url('IMAGENES/DesiertoAncho.jpg')",
                mapa: "url('IMAGENES/Desierto/mapa_desierto.jpg')",
                celdas: {
                    piso: "url('IMAGENES/Desierto/plataforma_desierto.png')",
                    pared: "url('IMAGENES/Desierto/pared_desierto.png')",
                    puerta: "url('IMAGENES/Desierto/puerta_desierto.png')",
                    cofre: "url('IMAGENES/Desierto/cofre_desierto.png')",
                    meta: "url('IMAGENES/Desierto/meta_desierto.png')",
                    personaje: "url('IMAGENES/Desierto/drago_desierto.png')",
                    estiloExtra: {
                        sombra: "0 2px 5px rgba(210, 180, 140, 0.3)"
                    }
                },
                colorTema: "#c2b280"
            },
            2: { // Mundo Jungla
                fondo: "url('IMAGENES/JunglaAncho.jpg')",
                mapa: "url('IMAGENES/Jungla/mapa_jungla.jpg')",
                celdas: {
                    piso: "url('IMAGENES/Jungla/plataforma_jungla.png')",
                    pared: "url('IMAGENES/Jungla/pared_jungla.png')",
                    puerta: "url('IMAGENES/Jungla/puerta_jungla.png')",
                    cofre: "url('IMAGENES/Jungla/cofre_jungla.png')",
                    meta: "url('IMAGENES/Jungla/meta_jungla.png')",
                    personaje: "url('IMAGENES/Jungla/drago_jungla.png')",
                    estiloExtra: {
                        sombra: "0 2px 5px rgba(46, 139, 87, 0.3)"
                    }
                },
                colorTema: "#4a7729"
            },
            3: { // Mundo Hielo
                fondo: "url('IMAGENES/NieveAncho.jpg')",
                mapa: "url('IMAGENES/Hielo/mapa_hielo.jpg')",
                celdas: {
                    piso: "url('IMAGENES/Hielo/plataforma_hielo.png')",
                    pared: "url('IMAGENES/Hielo/pared_hielo.png')",
                    puerta: "url('IMAGENES/Hielo/puerta_hielo.png')",
                    cofre: "url('IMAGENES/Hielo/cofre_hielo.png')",
                    meta: "url('IMAGENES/Hielo/meta_hielo.png')",
                    personaje: "url('IMAGENES/Hielo/drago_hielo.png')",
                    estiloExtra: {
                        sombra: "0 2px 5px rgba(163, 217, 255, 0.3)"
                    }
                },
                colorTema: "#67c0ff"
            }
        };

        // ========== VARIABLES DEL JUEGO ==========
        let mazeData = [];
        let correctAnswer = 0;
        let mazeCols = 0;
        let mazeRows = 0;
        let cellSize = 0;
        let playerPos = { x: 0, y: 0 };
        let goalPos = { x: 0, y: 0 };
        let commands = [];
        let commandIndex = 0;
        let paused = false;
        let doorPassed = false;
        let chestCollected = false;
        let dificultad = 1;
        let mundo = 1;
        let nivelActual = 1;
        const TOTAL_NIVELES = 15;

        // ========== FUNCIONES PRINCIPALES ==========
        window.onload = function() {
            // Configuración inicial
            dificultad = parseInt(localStorage.getItem('dificultad')) || 1;
            nivelActual = parseInt(localStorage.getItem('nivelActual')) || 1;
            
            // Determinar el mundo basado en el nivel
            mundo = Math.ceil(nivelActual / 5);           
            
            // Actualizar indicador de nivel
            document.getElementById('current-level').textContent = nivelActual;
            
            // Configurar laberinto
            configurarLaberinto(mundo, nivelActual);
            
            // Mostrar tutorial solo en el primer nivel DE CADA MUNDO
            if (nivelActual == 1 || nivelActual == 6 || nivelActual == 11) {
                const tuto = document.getElementById("tuto");
                tuto.style.display = "block";
            }
        };
        //========== Configurar audio ==========    
        function sonidoMover(){
            let moverse=new Audio('moverse.wav');
            moverse.play();
        } 
        function sonidoObjetivo(){
            let objetivos=new Audio('objetivo.wav');
            objetivos.play();
        }
        function sonidoMeta(){
            let ganar=new Audio('ganar.mp3');
            ganar.play();
        } 
        function sonidoPerder(){
            let perder=new Audio('perder.wav');
            perder.play();
        }
        function sonidoTocar(){
            let tocar=new Audio('tocar.mp3');
            tocar.play();
        }
        

        function calculateOptimalCellSize() {
            const maxCells = Math.max(mazeCols, mazeRows);
            const isZoomed = window.devicePixelRatio > 1.2;
 
            let baseSize;
            if (mundo === 1) { 
                baseSize = isZoomed ? 75 : 106; 
            } else if (mundo === 2) { 
                baseSize = isZoomed ? 66 : 94; 
            } else { 
                baseSize = isZoomed ? 60 : 85;
            }
            
            const maxSize = Math.min(baseSize, Math.floor(window.innerWidth * 0.7 / maxCells));
            return Math.max(25, maxSize);
        }

        function configurarLaberinto(mundo, nivel) {
            const estilo = estilosMundos[mundo] || estilosMundos[1];
            document.body.setAttribute('data-mundo',mundo);
            // Cambiar fondo y tema
            document.body.style.backgroundImage = estilo.fondo;
            document.documentElement.style.setProperty('--color-tema', estilo.colorTema);
            
            // Determinar tamaño del laberinto basado en el nivel
            const baseSize = 5; // Tamaño base para los primeros 5 niveles
            const incremento = Math.floor((nivel - 1) / 5); // Aumenta cada 5 niveles
            const tamañoLaberinto = baseSize + incremento;
            
            // Generar laberinto según el nivel
            mazeData = generarLaberinto(nivel, tamañoLaberinto);
            
            // Configurar diseño del laberinto
            document.getElementById("maze").style.backgroundImage = estilo.mapa;
            actualizarTutorial(estilo.celdas);
            
            // Recalcular y renderizar
            mazeCols = mazeData[0].length;
            mazeRows = mazeData.length;
            cellSize = calculateOptimalCellSize();
            playerPos = { x: 0, y: 0 };
            goalPos = findGoalPosition();
            renderMaze();
        }

        function generarLaberinto(nivel, tamaño) {
            // Crear un laberinto vacío
            let laberinto = Array(tamaño).fill().map(() => Array(tamaño).fill(' '));
            
            // Colocar paredes de manera aleatoria pero asegurando que haya un camino
            for (let y = 0; y < tamaño; y++) {
                for (let x = 0; x < tamaño; x++) {
                    // Dejar los bordes libres para el jugador y la meta
                    if (x === 0 || y === 0 || x === tamaño-1 || y === tamaño-1) {
                        continue;
                    }
                    
                    // 30% de probabilidad de ser pared (ajustable según nivel)
                    if (Math.random() < 0.3 + (nivel * 0.01)) {
                        laberinto[y][x] = CELL_TYPES.WALL;
                    }
                }
            }
            
            // Asegurar que el jugador empiece en (0,0) y la meta en el extremo opuesto
            laberinto[0][0] = ' '; // Posición inicial del jugador
            laberinto[tamaño-1][tamaño-1] = CELL_TYPES.GOAL; // Meta
            
            // Colocar una puerta y un cofre en posiciones aleatorias pero accesibles
            let puertaColocada = false;
            let cofreColocado = false;
            
            while (!puertaColocada || !cofreColocado) {
                const x = Math.floor(Math.random() * (tamaño - 2)) + 1;
                const y = Math.floor(Math.random() * (tamaño - 2)) + 1;
                
                // No colocar en la posición inicial ni en la meta
                if ((x === 0 && y === 0) || (x === tamaño-1 && y === tamaño-1)) {
                    continue;
                }
                
                // Colocar puerta si no está colocada
                if (!puertaColocada && laberinto[y][x] === ' ') {
                    laberinto[y][x] = CELL_TYPES.DOOR;
                    puertaColocada = true;
                    continue;
                }
                
                // Colocar cofre si no está colocado
                if (!cofreColocado && laberinto[y][x] === ' ') {
                    laberinto[y][x] = CELL_TYPES.CHEST;
                    cofreColocado = true;
                }
            }
            
            return laberinto;
        }

        function renderMaze() {
            const maze = document.getElementById("maze");
            maze.innerHTML = '';
            
            maze.style.gridTemplateColumns = `repeat(${mazeCols}, ${cellSize}px)`;
            maze.style.gridTemplateRows = `repeat(${mazeRows}, ${cellSize}px)`;
            
            const estilo = estilosMundos[mundo] || estilosMundos[1];
            maze.style.backgroundImage = estilo.mapa;
            maze.style.boxShadow = estilo.celdas.estiloExtra.sombra;

            mazeData.forEach((row, y) => {
                row.forEach((cell, x) => {
                    const cellElement = document.createElement("div");
                    cellElement.className = "cell";
                    cellElement.style.backgroundImage = estilo.celdas.piso;
                    
                    if (cell === CELL_TYPES.WALL) {
                        cellElement.classList.add("wall");
                        cellElement.style.backgroundImage = estilo.celdas.pared;
                    }
                    if (cell === CELL_TYPES.DOOR) {
                        cellElement.classList.add("door");
                        cellElement.style.backgroundImage = estilo.celdas.puerta;
                    }
                    if (cell === CELL_TYPES.CHEST) {
                        cellElement.classList.add("chest");
                        cellElement.style.backgroundImage = estilo.celdas.cofre;
                    }
                    if (cell === CELL_TYPES.GOAL) {
                        cellElement.classList.add("goal");
                        cellElement.style.backgroundImage = estilo.celdas.meta;
                    }
                    if (playerPos.x === x && playerPos.y === y) {
                        cellElement.classList.add("player");
                        cellElement.style.backgroundImage = estilo.celdas.personaje;
                    }
                    
                    maze.appendChild(cellElement);
                });
            });
        }

        function actualizarTutorial(estilos) {
            const tutorial = document.getElementById("tuto");
            tutorial.style.borderColor = estilos.estiloExtra.colorBorde;
            tutorial.style.boxShadow = estilos.estiloExtra.sombra;

            document.getElementById('tuto-personaje').style.backgroundImage = estilos.personaje;
            
            document.querySelectorAll('.tuto-img').forEach(img => {
                const type = img.getAttribute('data-type');
                img.style.backgroundImage = estilos[type];
                img.style.border = `1px solid ${estilos.estiloExtra.colorBorde}`;
            });
        }

        function findGoalPosition() {
            for (let y = 0; y < mazeRows; y++) {
                for (let x = 0; x < mazeCols; x++) {
                    if (mazeData[y][x] === CELL_TYPES.GOAL) {
                        return { x, y };
                    }
                }
            }
            return { x: mazeCols - 1, y: mazeRows - 1 };
        }

        window.addEventListener('resize', () => {
            const newSize = calculateOptimalCellSize();
            if (newSize !== cellSize) {
                cellSize = newSize;
                renderMaze();
            }
        });

        // ========== FUNCIONES DE JUEGO ==========
        function addCommand(direction) {
            sonidoTocar();
            if (commands.length > 0 && commands[commands.length - 1].direction === direction) {
                commands[commands.length - 1].count++;
            } else {
                commands.push({ direction: direction, count: 1 });
            }
            
            updateCommandList();
        }

        function updateCommandList() {
            const commandList = document.getElementById("command-list");
            commandList.innerHTML = '';

            commands.forEach(cmd => {
                let arrow = '';
                if (cmd.direction === 'up') arrow = '↑';
                if (cmd.direction === 'down') arrow = '↓';
                if (cmd.direction === 'left') arrow = '←';
                if (cmd.direction === 'right') arrow = '→';

                const div = document.createElement('div');
                div.innerHTML = `${arrow} <strong>x${cmd.count}</strong>`;
                commandList.appendChild(div);
            });
        }

        function startGame() {
            commandIndex = 0;
            paused = false;
            doorPassed = false;
            chestCollected = false;
            executeCommands();
        }

        function executeCommands() {
            if (paused) return;

            if (playerPos.x === goalPos.x && playerPos.y === goalPos.y) {
                return;
            }

            if (commandIndex >= commands.length) {
                if (!(playerPos.x === goalPos.x && playerPos.y === goalPos.y)) {
                    sonidoPerder();
                    document.getElementById("restart-message").style.display = "block";
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                }
                return;
            }

            const currentCommand = commands[commandIndex];
            if (currentCommand.count > 0) {
                move(currentCommand.direction);
                currentCommand.count--;
            } else {
                commandIndex++;
            }

            setTimeout(executeCommands, 500);
        }

        function move(direction) {
            if (playerPos.x === goalPos.x && playerPos.y === goalPos.y) return;

            let newX = playerPos.x;
            let newY = playerPos.y;

            switch(direction) {
                case 'up': newY--; break;
                case 'down': newY++; break;
                case 'left': newX--; break;
                case 'right': newX++; break;
            }

            if (newX < 0 || newY < 0 || newX >= mazeCols || newY >= mazeRows || 
                mazeData[newY][newX] === CELL_TYPES.WALL) {
                return;
            }

            playerPos = { x: newX, y: newY };
            sonidoMover();
            renderMaze();
            handleCellInteractions(newX, newY);
        }

        function handleCellInteractions(x, y) {
            const cellType = mazeData[y][x];
            
            switch(cellType) {
                case CELL_TYPES.DOOR:
                    if (!doorPassed) {
                        paused = true;
                        doorPassed = true;
                        openModal('door');
                    }
                    break;
                    
                case CELL_TYPES.CHEST:
                    if (!chestCollected) {
                        paused = true;
                        chestCollected = true;
                        openModal('chest');
                    }
                    
                    break;
                    
                case CELL_TYPES.GOAL:
                    paused = true;
                    document.getElementById("goal-finish").classList.add("blink");
                    showWinScreen();
                    sonidoMeta();
                    break;
            }
        }

        function openModal(type) {
            document.getElementById("modal").style.display = "flex";
            document.getElementById("question").innerText = generateQuestion();
            if (type === 'door') {
                document.getElementById("goal-door").classList.add("blink");
            }
            if (type === 'chest') {
                document.getElementById("goal-chest").classList.add("blink");
            }
        }

        function generateQuestion() {
            let num1, num2, operador;
            
            switch(dificultad) {
                case 1: // Nivel 1: Suma y resta de 2 cifras <100
                    num1 = Math.floor(Math.random() * 99) + 1;
                    num2 = Math.floor(Math.random() * 99) + 1;
                    if (Math.random() > 0.5) {
                        operador = '+';
                        correctAnswer = num1 + num2;
                    } else {
                        operador = '-';
                        if (num1 < num2) [num1, num2] = [num2, num1]; // Evitar resultados negativos
                        correctAnswer = num1 - num2;
                    }
                    break;
                    
                case 2: // Nivel 2: Suma/resta 3 cifras <1000, multiplicación/división (tablas 1-10)
                    if (Math.random() > 0.5) { // 50% probabilidad de suma/resta
                        num1 = Math.floor(Math.random() * 333) + 1;
                        num2 = Math.floor(Math.random() * 333) + 1;
                        if (Math.random() > 0.5) {
                            operador = '+';
                            correctAnswer = num1 + num2;
                        } else {
                            operador = '-';
                            if (num1 < num2) [num1, num2] = [num2, num1];
                            correctAnswer = num1 - num2;
                        }
                    } else { // 50% probabilidad de multiplicación/división
                        num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                        num2 = Math.floor(Math.random() * 6) + 1; // 1-6 (tabla del 6)
                        if (Math.random() > 0.5) {
                            operador = '*';
                            correctAnswer = num1 * num2;
                        } else {
                            operador = '/';
                            // Asegurar división exacta
                            correctAnswer = num1;
                            num1 = num1 * num2;
                            correctAnswer = num1 / num2;
                        }
                    }
                    break;
                    
                case 3: // Nivel 3: Suma/resta 4 cifras, multiplicación/división 2 cifras
                    if (Math.random() > 0.5) { // 50% probabilidad de suma/resta
                        num1 = Math.floor(Math.random() * 555) + 1;
                        num2 = Math.floor(Math.random() * 555) + 1;
                        if (Math.random() > 0.5) {
                            operador = '+';
                            correctAnswer = num1 + num2;
                        } else {
                            operador = '-';
                            if (num1 < num2) [num1, num2] = [num2, num1];
                            correctAnswer = num1 - num2;
                        }
                    } else { // 50% probabilidad de multiplicación/división
                        num1 = Math.floor(Math.random() * 99) + 1; // 1-99
                        num2 = Math.floor(Math.random() * 99) + 1; // 1-99
                        if (Math.random() > 0.5) {
                            operador = '*';
                            correctAnswer = num1 * num2;
                        } else {
                            // División (asegurar que sea exacta y con números de 2 cifras)
                            num2 = Math.floor(Math.random() * 9) + 2; // 2-10 (divisor)
                            correctAnswer = Math.floor(Math.random() * 9) + 10; // 10-99 (cociente)
                            num1 = num2 * correctAnswer; // Dividendo
                            
                            // Asegurarnos que el dividendo (num1) tenga exactamente 2 cifras
                            while(num1 < 10 || num1 > 99) {
                                num2 = Math.floor(Math.random() * 9) + 2; // 2-10
                                correctAnswer = Math.floor(Math.random() * 9) + 10; // 10-99
                                num1 = num2 * correctAnswer;
                            }
                            operador = '/';
                        }
                    }
                    break;
            }
            return `¿Cuánto es ${num1} ${operador} ${num2}?`;
        }

        function checkAnswer() {
            const answerInput = document.getElementById("answer");
            let userAnswer = parseInt(answerInput.value);
            
            if (isNaN(userAnswer)) {
                alert("Por favor ingresa un número válido");
                return;
            }

            if (userAnswer === correctAnswer) {
                document.getElementById("modal").style.display = "none";
                paused = false;
                answerInput.value = "";
                setTimeout(executeCommands, 500);
                sonidoObjetivo();
            } else {
                alert("Respuesta incorrecta. Inténtalo de nuevo.");
                answerInput.value = "";
                answerInput.focus();
            }
        }

        function showWinScreen() {
            document.getElementById("win-modal").style.display = "flex";
            document.getElementById("star1").classList.add(doorPassed ? "gold" : "black");
            document.getElementById("star2").classList.add(chestCollected ? "gold" : "black");
            document.getElementById("star3").classList.add("gold");
        }

        function changeLevel(parametro) {
            if (parametro === 2 && nivelActual < TOTAL_NIVELES) {
                nivelActual++;
                localStorage.setItem('nivelActual', nivelActual);
            } else if (parametro === 1) {
                // Reiniciar el nivel actual
            }
            
            location.reload();
        }

        function tutorial(parametro) {
            if (parametro == 1) {
                const tuto = document.getElementById("tuto2");
                document.getElementById("tuto").style.display = "none";
                tuto.style.display = "block";
            } else {
                document.getElementById("tuto2").style.display = "none";
            }
        }
    </script>
</body>
</html>
